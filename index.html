<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CX Analytics Dashboard</title>

    <!-- Tech Stack: Tailwind CSS, FontAwesome, Chart.js, PapaParse -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Revibe Design Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            purple: '#8b5cf6',
                            red: '#ef4444',
                            green: '#10b981',
                            yellow: '#f59e0b'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Glassmorphism Classes */
        .glass {
            background: rgba(15, 23, 42, 0.75);
            /* Darker glass for better readability */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transform: translateZ(0);
            /* Hardware acceleration to reduce lag */
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        body {
            font-family: 'Montserrat', sans-serif;
        }

        /* Revibe Background Accents */
        .circle-accent {
            position: fixed;
            top: 50%;
            left: 55%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.05);
            pointer-events: none;
            z-index: 0;
        }

        .glow-accent {
            position: fixed;
            top: 30%;
            right: 10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, rgba(0, 0, 0, 0) 70%);
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>

<body class="text-gray-200 antialiased h-screen flex overflow-hidden">

    <!-- Background Elements -->
    <!-- Fixed Background Layer for Performance (Prevents scroll lag) -->
    <div class="fixed inset-0 z-0 pointer-events-none"
        style="background: linear-gradient(105deg, #0f172a 0%, #2e1065 50%, #500724 100%);"></div>
    <div class="circle-accent"></div>
    <div class="glow-accent"></div>

    <!-- Security Lock Modal -->
    <div id="securityModal" class="fixed inset-0 bg-slate-900 z-[100] hidden flex items-center justify-center">
        <div class="glass p-8 rounded-xl w-full max-w-md border border-slate-700 text-center shadow-2xl">
            <div
                class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-accent-red">
                <i class="fa-solid fa-lock text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">Restricted Access</h2>
            <p class="text-sm text-gray-400 mb-6">This dashboard is encrypted. Please enter the password to decrypt the
                data sources.</p>
            <input type="password" id="securityPassword"
                class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white focus:border-accent-red outline-none mb-4"
                placeholder="Enter Password">
            <button onclick="unlockDashboard()"
                class="w-full bg-accent-red hover:bg-red-600 text-white font-bold py-3 rounded transition-colors shadow-lg">Unlock
                Dashboard</button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-accent-blue mb-4"></div>
        <h2 class="text-xl font-bold text-accent-blue animate-pulse">Loading Support Data...</h2>
        <p class="text-sm text-gray-500 mt-2">Connecting to Data Source</p>
    </div>

    <!-- Sidebar Filters -->
    <aside
        class="w-64 glass h-full flex-shrink-0 flex flex-col p-4 border-r border-slate-700/50 relative z-20 overflow-y-auto">
        <div class="mb-5 flex items-center gap-3">
            <img src="css/revibe.png" alt="Revibe Logo" class="w-12 h-12 rounded-full object-cover shadow-md">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tighter text-white leading-none">REVIBE</h1>
                <p class="text-[10px] text-gray-400 tracking-widest uppercase font-semibold">CX Analytics</p>
            </div>
        </div>

        <div class="space-y-3">
            <!-- Country Selector -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Region</label>
                <select id="countryFilter"
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs text-white focus:ring-accent-blue focus:border-accent-blue">
                    <option value="All">All Regions</option>
                    <option value="KSA">KSA (Saudi Arabia)</option>
                    <option value="UAE">UAE (United Arab Emirates)</option>
                    <option value="ZA">ZA (South Africa)</option>
                </select>
            </div>

            <!-- Source Selector -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Source</label>
                <select id="sourceFilter"
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs text-white focus:ring-accent-blue focus:border-accent-blue">
                    <option value="Widget">Chat Widget</option>
                    <option value="Whatsapp">Whatsapp</option>
                </select>
            </div>

            <!-- Date Range -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Date Range</label>
                <div class="grid gap-3">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-regular fa-calendar text-gray-500"></i>
                        </div>
                        <input type="date" id="startDate"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg pl-10 p-2 text-xs text-white">
                    </div>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-regular fa-calendar text-gray-500"></i>
                        </div>
                        <input type="date" id="endDate"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg pl-10 p-2 text-xs text-white">
                    </div>
                </div>
            </div>

            <!-- Compare Toggle -->
            <div class="flex items-center justify-between p-2 glass rounded-lg border border-slate-700">
                <span class="text-xs font-medium text-gray-300">Compare Prev. Period</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="compareToggle" class="sr-only peer">
                    <div
                        class="w-9 h-5 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-blue rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent-blue">
                    </div>
                </label>
            </div>

            <!-- CSAT Filter Toggle -->
            <div class="flex items-center justify-between p-2 glass rounded-lg border border-slate-700 mt-1">
                <span class="text-xs font-medium text-gray-300">Show Rated Only (CSAT)</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="csatToggle" class="sr-only peer">
                    <div
                        class="w-9 h-5 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-yellow rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent-yellow">
                    </div>
                </label>
            </div>

            <!-- Test Mode Toggle -->
            <div
                class="flex items-center justify-between p-2 glass rounded-lg border border-slate-700 mt-1 border-accent-red/30">
                <span class="text-xs font-medium text-accent-red">Test Mode</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="testModeToggle" class="sr-only peer">
                    <div
                        class="w-9 h-5 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-red rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent-red">
                    </div>
                </label>
            </div>

            <button onclick="applyFilters()"
                class="w-full bg-gradient-to-r from-accent-blue to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-medium py-2 rounded-lg shadow-lg transition-all transform hover:scale-105 text-sm">
                Apply Filters
            </button>
        </div>

        <div class="mt-auto pt-4 border-t border-slate-700">
            <button onclick="window.location.href='views/credentials.html'"
                class="w-full flex items-center justify-center gap-2 text-gray-400 hover:text-white transition-colors mb-1.5 py-1.5 rounded-lg hover:bg-slate-800 text-xs">
                <i class="fa-solid fa-key"></i> Credentials Manager
            </button>
            <button onclick="openSettings()"
                class="w-full flex items-center justify-center gap-2 text-gray-400 hover:text-white transition-colors mb-1.5 py-1.5 rounded-lg hover:bg-slate-800 text-xs">
                <i class="fa-solid fa-database"></i> Data Manager
            </button>
            <button onclick="openAIModal()"
                class="w-full flex items-center justify-center gap-2 text-accent-purple hover:text-white transition-colors mb-1.5 py-1.5 rounded-lg hover:bg-slate-800 border border-slate-700 hover:border-accent-purple/50 text-xs">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Analyst
            </button>
            <button onclick="openTicketIntelligenceModal()"
                class="w-full flex items-center justify-center gap-2 text-accent-green hover:text-white transition-colors mb-1.5 py-1.5 rounded-lg hover:bg-slate-800 border border-slate-700 hover:border-accent-green/50 text-xs">
                <i class="fa-solid fa-brain"></i> Ticket Intelligence
            </button>
            <button onclick="window.location.href='views/automation_center.html'"
                class="w-full flex items-center justify-center gap-2 text-accent-red hover:text-white transition-colors mb-1.5 py-1.5 rounded-lg hover:bg-slate-800 border border-slate-700 hover:border-accent-red/50 text-xs">
                <i class="fa-solid fa-robot"></i> Automation Center
            </button>
            <button onclick="openReportsArchive()"
                class="w-full flex items-center justify-center gap-2 text-gray-400 hover:text-white transition-colors mb-1.5 py-1.5 rounded-lg hover:bg-slate-800 text-xs">
                <i class="fa-solid fa-archive"></i> Reports Archive
            </button>
            <p id="dataStatusText" class="text-xs text-gray-500 text-center">Data fetched via API / CSV</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8 relative z-10">
        <!-- Header with Sync Button -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Dashboard Overview</h2>
            <div class="flex flex-col items-end">
                <button onclick="syncAll()" id="syncAllBtn"
                    class="bg-accent-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-lg">
                    <i class="fa-solid fa-rotate"></i> Sync All Data
                </button>
                <span id="lastSyncText" class="text-xs text-gray-500 mt-1">Last Sync: Never</span>
            </div>
        </div>

        <!-- Section A: Executive KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8">

            <!-- Total Volume -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-purple relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Total Tickets</p>
                        <h3 id="kpiTotalVolume" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-purple">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                </div>
                <div id="trendVolume" class="mt-4 text-xs font-medium flex items-center gap-1">
                    <!-- Dynamic Trend content -->
                </div>
            </div>

            <!-- Escalation Rate -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-red relative">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Human Escalation</p>
                        <h3 id="kpiEscalation" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-red">
                        <i class="fa-solid fa-user-headset"></i>
                    </div>
                </div>
                <div id="trendEscalation" class="mt-4 text-xs font-medium text-gray-400">
                    Calculated from 'Requested Agent'
                </div>
            </div>

            <!-- Sentiment Score -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-green">
                <p class="text-sm text-gray-400 font-medium uppercase mb-2">Sentiment Overview</p>
                <div class="flex h-4 w-full rounded-full overflow-hidden bg-slate-800 mb-2">
                    <div id="barPositive" class="bg-accent-green h-full" style="width: 0%"></div>
                    <div id="barNeutral" class="bg-gray-500 h-full" style="width: 0%"></div>
                    <div id="barNegative" class="bg-accent-red h-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-accent-green"><i class="fa-regular fa-face-smile"></i> <span
                            id="valPositive">0%</span></span>
                    <span class="text-gray-400"><i class="fa-regular fa-face-meh"></i> <span
                            id="valNeutral">0%</span></span>
                    <span class="text-accent-red"><i class="fa-regular fa-face-frown"></i> <span
                            id="valNegative">0%</span></span>
                </div>
            </div>

            <!-- Avg AI Messages -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-blue">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Avg Bot Msgs/Ticket</p>
                        <h3 id="kpiAvgMsgs" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-blue">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                </div>
                <div class="mt-4 text-xs font-medium text-gray-400">
                    Indicator of automation depth
                </div>
            </div>

            <!-- Avg CSAT (New) -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-yellow">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Avg CSAT</p>
                        <h3 id="kpiAvgCsat" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-yellow">
                        <i class="fa-solid fa-star"></i>
                    </div>
                </div>
                <div id="csatResponseRate" class="mt-4 text-xs font-medium text-gray-400">
                    Response Rate: 0%
                </div>
            </div>
        </div>

        <!-- Section B: Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Line Chart: Volume -->
            <div class="glass rounded-xl p-6 lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4 text-white">Ticket Volume Over Time</h3>
                <div class="relative h-64 w-full">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Doughnut Chart: Categories -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-white">Category Distribution</h3>
                <div class="relative h-64 w-full flex justify-center">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- CSAT vs Sentiment Chart (New) -->
            <div class="glass rounded-xl p-6 lg:col-span-3">
                <h3 class="text-lg font-semibold mb-4 text-white">CSAT vs Sentiment Validation</h3>
                <div class="relative h-64 w-full">
                    <canvas id="csatChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Section C: Analysis & Top Issues -->
        <div class="grid grid-cols-1 gap-6 pb-8">
            <!-- Top Intents Bar Chart -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-white flex items-center gap-2">
                    <i class="fa-solid fa-crosshairs text-accent-yellow"></i> Top Intents
                </h3>
                <div class="relative h-64 w-full">
                    <canvas id="intentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Section C.5: Deeper Issue Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">

            <!-- Bot Issues -->
            <div class="glass rounded-xl p-5 border-l-4 border-gray-400 relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Bot Issues</p>
                        <h3 id="kpiBotIssues" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-gray-400">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                </div>
                <div id="listBotIssues"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="openCategoryAnalysis('Bot category', 'Bot suggestions', 'Bot Issues')"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>

            <!-- Website Issues -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-yellow relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Website Issues</p>
                        <h3 id="kpiWebsiteIssue" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-yellow">
                        <i class="fa-solid fa-desktop"></i>
                    </div>
                </div>
                <div id="listWebsiteIssues"></div>
                <div class="flex gap-2 mt-4">
                    <button
                        onclick="openCategoryAnalysis('website issue category', 'website issue description', 'Website Issues')"
                        class="flex-1 bg-accent-yellow hover:bg-yellow-500 text-black py-2 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>

            <!-- Reason Not Buying -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-red relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Reason Not Buying</p>
                        <h3 id="kpiReasonNotBuying" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-red">
                        <i class="fa-solid fa-cart-arrow-down"></i>
                    </div>
                </div>
                <div id="listReasonNotBuying"></div>
                <div class="flex gap-2 mt-4">
                    <button
                        onclick="openCategoryAnalysis('reason_not_buying_category', 'reason_not_buying_description', 'Reason Not Buying')"
                        class="flex-1 bg-accent-red hover:bg-red-600 text-white py-2 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>

            <!-- Angry Customers -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-purple relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Angry Customers</p>
                        <h3 id="kpiAngryReason" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-purple">
                        <i class="fa-solid fa-face-angry"></i>
                    </div>
                </div>
                <div id="listAngryReason"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="openCategoryAnalysis('anger_category', 'angry_reason', 'Angry Customers')"
                        class="flex-1 bg-accent-purple hover:bg-purple-600 text-white py-2 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>

            <!-- Device Quality -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-green relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Device Quality</p>
                        <h3 id="kpiDeviceQuality" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-green">
                        <i class="fa-solid fa-mobile-screen-button"></i>
                    </div>
                </div>
                <div id="listDeviceQuality"></div>
                <div class="flex gap-2 mt-4">
                    <button
                        onclick="openCategoryAnalysis('device_quality_category', 'device_quality_description', 'Device Quality')"
                        class="flex-1 bg-accent-green hover:bg-green-600 text-white py-2 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>

            <!-- Pricing Issues -->
            <div class="glass rounded-xl p-5 border-l-4 border-accent-blue relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-400 font-medium uppercase">Pricing Issues</p>
                        <h3 id="kpiPricingTopic" class="text-3xl font-bold text-white mt-2">-</h3>
                    </div>
                    <div class="p-2 bg-slate-800 rounded-lg text-accent-blue">
                        <i class="fa-solid fa-tags"></i>
                    </div>
                </div>
                <div id="listPricingTopic"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="openCategoryAnalysis('pricing_category', 'pricing_description', 'Pricing Issues')"
                        class="flex-1 bg-accent-blue hover:bg-blue-600 text-white py-2 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>
        </div>

        <!-- Section C.6: Issues Visualization -->
        <div class="glass rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-white flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-accent-blue"></i> Issue Landscape
            </h3>
            <div class="relative h-80 w-full">
                <canvas id="issuesLandscapeChart"></canvas>
            </div>
        </div>

        <!-- Section D: AI Recommendations -->
        <div class="glass rounded-xl p-6 mb-8 border border-accent-purple/30">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles text-accent-purple"></i>
                    AI Recommendations
                </h3>
                <div class="flex gap-2">
                    <button onclick="openRecommendationsModal()"
                        class="bg-accent-purple hover:bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold transition-colors shadow-lg">
                        More Details
                    </button>
                </div>
            </div>
            <div id="recommendationsGrid" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-4">
                <!-- Recommendations injected via JS -->
            </div>
        </div>

    </main>

    <div id="settingsModalContainer"></div>
    <div id="ticketIntelligenceModalContainer"></div>
    <div id="aiModalContainer"></div>
    <div id="reportsArchiveModalContainer"></div>
    <div id="issueAnalysisModalContainer"></div>

    <!-- Category Details Modal -->
    <div id="categoryDetailsModal"
        class="fixed inset-0 bg-slate-900/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-5xl rounded-xl border border-slate-700 flex flex-col h-[85vh] shadow-2xl">
            <!-- Header -->
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                <h3 id="catModalTitle" class="text-lg font-bold text-white">Analysis</h3>
                <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                <!-- Left: Categories List -->
                <div class="w-full md:w-1/3 border-r border-slate-700 flex flex-col bg-slate-900/30">
                    <div class="p-3 border-b border-slate-700 bg-slate-800/30">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Categories</h4>
                    </div>
                    <div id="catModalList" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <!-- Categories injected here -->
                    </div>
                </div>

                <!-- Right: Tickets/Descriptions -->
                <div class="w-full md:w-2/3 flex flex-col bg-slate-800/20">
                    <div class="p-3 border-b border-slate-700 bg-slate-800/30 flex justify-between items-center">
                        <h4 id="catModalSubtitle" class="text-xs font-bold text-gray-400 uppercase">Select a category
                        </h4>
                        <span id="catModalCount" class="text-[10px] text-gray-500"></span>
                    </div>
                    <div id="catModalContent" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <!-- Tickets injected here -->
                    </div>
                    <!-- Pagination Controls -->
                    <div id="catModalPagination"
                        class="p-3 border-t border-slate-700 bg-slate-800/30 flex justify-center">
                        <button id="catModalLoadMoreBtn" onclick="renderMoreTickets()"
                            class="hidden bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded text-xs font-bold transition-colors shadow-lg">
                            Show More <i class="fa-solid fa-chevron-down ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Details Modal -->
    <div id="recommendationsModal"
        class="fixed inset-0 bg-slate-900/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-4xl rounded-xl border border-slate-700 flex flex-col max-h-[85vh] shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                <h3 class="text-lg font-bold text-white">Top Recommendations</h3>
                <button onclick="document.getElementById('recommendationsModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div class="flex justify-end mb-4">
                    <button onclick="generateRecommendationsSummary()"
                        class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded text-xs font-bold transition-colors border border-slate-600 shadow-sm flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> Generate AI Summary
                    </button>
                </div>
                <div id="recSummaryContainer"
                    class="hidden mb-6 p-4 bg-slate-800/80 rounded-lg border border-accent-purple/30">
                    <div id="recSummaryText" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap"></div>
                </div>
                <div id="recommendationsModalList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Transcript Modal -->
    <div id="transcriptModal" class="fixed inset-0 bg-slate-900/95 z-[110] hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-3xl rounded-xl border border-slate-700 flex flex-col max-h-[80vh] shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                <h3 class="text-lg font-bold text-white">Ticket Transcript</h3>
                <button onclick="document.getElementById('transcriptModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto font-mono text-xs text-gray-300 whitespace-pre-wrap leading-relaxed"
                id="transcriptContent"></div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script src="js/ticket_intelligence.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadModal('settingsModalContainer', 'modals/settingsModal.html');
            loadModal('ticketIntelligenceModalContainer', 'modals/ticketIntelligenceModal.html');
            loadModal('aiModalContainer', 'modals/aiModal.html');
            loadModal('reportsArchiveModalContainer', 'modals/reportsArchiveModal.html');
            loadModal('issueAnalysisModalContainer', 'modals/issueAnalysisModal.html');
        });

        function loadModal(targetId, url) {
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    document.getElementById(targetId).innerHTML = html;
                })
                .catch(err => console.warn(`Failed to load modal from ${url}`, err));
        }
    </script>
    <script>
        // ==========================================
        // üîß CONFIGURATION
        // ==========================================

        // --- SECURITY SETTINGS ---
        // 1. To secure your links, open Settings > Security in the dashboard.
        // 2. Generate the encrypted config using a password.
        // 3. Paste the result into SECURE_DEFAULTS below and set SECURE_MODE to true.
        // 4. You can then remove the links from PLAIN_DEFAULTS.

        const SECURE_MODE = true; // Set to TRUE after pasting encrypted defaults

        const SECURE_DEFAULTS = "U2FsdGVkX193obTYTyespP3TLxsiJGVDvdWC7qBNVXPpSJlYsRr1RcZuQv9HdbEc6UMT004jAeMntiAOhmsQLDy1OWkK1zSU5/kVxDo2u1xIwI4AWH/K51spH2HXKeT4f8LQJcuDadL64HYNFzb0pbVp0mDH9wGCoqZtdH4g9oLtBQoNmOHdH1PfUtHYUi7w7kHtoAFz3d0D0P3vRjubE/BZfH7oI49OzKZ/Wi9KC672GpFouGYt15hFLtih+5E4SR/msSgoCzSvgYv3SNO3PnbbwDIAaIrh3VFmidfvra9TPNfBO8XEZrE5QrlKDwV1XnHIeu4qbfyt6pNfwiMXzdfpI3Khr3O36o5jqV1CGquuIxA7OuIFHaN6DFRhHipsmb519oOG03eB6GxOQPNmrWdJSSMyHezHuUFddLdgVx9KJky8rh0fGU4PLYGA+gPb2m2w9bgqdkQOfS+/VmVER29cjx62LLKYT41FDgSsko8/txM9kvXBV/RXYmf+Kv58YB0tLg7BeguIhhJRejyoG94dfQ+WUUY5XCVC9KZ0TKCZTF/nXougipn8jCIOW3kioEYPYwRUMq78EB1KbwPsETMMA3IZtAgpupLgDSMVp02U/VYomD+rIWwgS10YYLbJeDr1VboDCnPJut6O3WcPy8vIqa4p1ZS1OscbB4QDwNumA6Drh6lFqWeYUfuS25mlM7x2QYqyw87MPvdvMwgowRTnX03j5YqKpn/Hvtl/An11+QgwM6vpXr1dOcPpWH+IjK2FB+qc3uU9Ifo9X0ScOuEuoprJKt7KQkX8C/eXHRk4rQQykr7WTK6xfPB00yutHAn3iHzFBoM9Gq3suOCoXg==";

        const PLAIN_DEFAULTS = {
            'Master': '',
            'KSA_Widget': '',
            'UAE_Widget': '',
            'ZA_Widget': '',
            'KSA_Whatsapp': '',
            'UAE_Whatsapp': '',
            'ZA_Whatsapp': '',
            'Test_Sheet': 'https://opensheet.elk.sh/15Gkf8FDqrF1TSTB4SmQ4doaPu99Uv6giQi1Cc4TJhAY/sheet4'
        };

        // Global Data Storage
        let rawData = [];
        let filteredData = [];
        let charts = {}; // To store chart instances
        let activeDefaults = {}; // Will hold the decrypted or plain defaults
        let currentRecommendations = []; // Store recommendations for modal

        // Database State (Initialized empty, populated on load)
        let database = {};

        // Helper to update the global "Last Sync" text
        function updateLastSyncDisplay() {
            let latest = 'Never';
            let maxTime = 0;

            Object.values(database).forEach(entry => {
                let t = 0;
                if (entry.updatedTs) {
                    t = entry.updatedTs;
                } else if (entry.updated && entry.updated !== 'Never') {
                    t = new Date(entry.updated).getTime();
                }

                if (!isNaN(t) && t > maxTime) {
                    maxTime = t;
                    latest = entry.updated;
                }
            });

            document.getElementById('lastSyncText').innerText = `Last Sync: ${latest}`;
        }

        // Helper to handle inconsistent column names (case/whitespace/underscores)
        function getValueFuzzy(row, colName) {
            if (!row || !colName) return undefined;
            if (row[colName] !== undefined) return row[colName];

            // Remove non-alphanumeric characters for loose matching
            const clean = str => str.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
            const target = clean(colName);

            const foundKey = Object.keys(row).find(k => clean(k) === target);
            return foundKey ? row[foundKey] : undefined;
        }

        // ==========================================
        // üóÑÔ∏è INDEXED DB (Storage Fix)
        // ==========================================
        const IDB_NAME = 'CX_Dashboard_DB';
        const IDB_VERSION = 2;
        const IDB_STORE_REGIONS = 'regions';
        const IDB_STORE_REPORTS = 'reports';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(IDB_NAME, IDB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(IDB_STORE_REGIONS)) {
                        db.createObjectStore(IDB_STORE_REGIONS, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(IDB_STORE_REPORTS)) {
                        db.createObjectStore(IDB_STORE_REPORTS, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function dbSaveRegion(regionKey, dataObj) {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE_REGIONS, 'readwrite');
                const store = tx.objectStore(IDB_STORE_REGIONS);
                store.put({ id: regionKey, ...dataObj });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function dbLoadAllRegionsRegions() {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE_REGIONS, 'readonly');
                const store = tx.objectStore(IDB_STORE_REGIONS);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbSaveReport(reportData) {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE_REPORTS, 'readwrite');
                const store = tx.objectStore(IDB_STORE_REPORTS);
                const request = store.add(reportData);
                tx.oncomplete = () => resolve(request.result);
                tx.onerror = () => reject(tx.error);
            });
        }

        async function dbLoadAllRegionsReports() {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(IDB_STORE_REPORTS, 'readonly');
                const store = tx.objectStore(IDB_STORE_REPORTS);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ==========================================
        //  INITIALIZATION
        // ==========================================

        // Pre-Init: Check Security
        if (SECURE_MODE) {
            const storedConfig = localStorage.getItem('cx_secure_config');
            if (storedConfig) {
                try {
                    activeDefaults = JSON.parse(storedConfig);
                    initializeDatabaseState();
                } catch (e) {
                    localStorage.removeItem('cx_secure_config');
                    document.getElementById('securityModal').classList.remove('hidden');
                    document.getElementById('loader').classList.add('hidden');
                }
            } else {
                document.getElementById('securityModal').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
            }
        } else {
            activeDefaults = PLAIN_DEFAULTS;
            initializeDatabaseState();
        }

        window.onload = async function () {
            if (SECURE_MODE && Object.keys(activeDefaults).length === 0) return;
            await startApp();
        };

        async function startApp() {
            // Load Database from IndexedDB
            try {
                const rows = await dbLoadAllRegionsRegions();
                rows.forEach(row => {
                    let key = row.id;
                    // Migration: Map old region keys to Widget keys
                    if (['KSA', 'UAE', 'ZA'].includes(key)) {
                        key = key + '_Widget';
                    }
                    if (database[key]) {
                        // Use saved URL if exists, otherwise keep default
                        const savedUrl = row.url;
                        const defaultUrl = activeDefaults[key] || '';

                        database[key] = {
                            data: row.data || [],
                            updated: row.updated || 'Never',
                            updatedTs: row.updatedTs || 0,
                            url: (savedUrl && savedUrl.trim() !== '') ? savedUrl : defaultUrl
                        };
                    }
                });
            } catch (e) {
                console.error("Failed to load DB:", e);
            }

            // Set default dates (Last 30 days)
            const today = new Date();
            const last30 = new Date();
            last30.setDate(today.getDate() - 30);
            // Load persisted state (Filters & Dates)
            if (!loadDashboardState()) {
                // Set default dates (Last 30 days) only if no state saved
                const today = new Date();
                const last30 = new Date();
                last30.setDate(today.getDate() - 30);

                document.getElementById('endDate').valueAsDate = today;
                document.getElementById('startDate').valueAsDate = last30;
                document.getElementById('endDate').valueAsDate = today;
                document.getElementById('startDate').valueAsDate = last30;
            }

            updateLastSyncDisplay();

            // Initial Load
            applyFilters();

            // Restore Generated Issues (AI Analysis)
            loadSavedTopIssues();

            // Hide loader after initialization
            document.getElementById('loader').classList.add('hidden');
        }

        function initializeDatabaseState() {
            // Populate database object structure from activeDefaults
            database = {};
            Object.keys(activeDefaults).forEach(key => {
                database[key] = { data: [], updated: 'Never', url: activeDefaults[key] };
            });
            // Ensure Test_Sheet exists even if not in defaults (e.g. old encrypted config)
            if (!database['Test_Sheet']) {
                database['Test_Sheet'] = { data: [], updated: 'Never', url: '' };
            }
        }

        // ==========================================
        // üîê SECURITY FUNCTIONS
        // ==========================================
        function unlockDashboard() {
            const password = document.getElementById('securityPassword').value;
            try {
                // Attempt to decrypt
                const decryptedBytes = CryptoJS.AES.decrypt(SECURE_DEFAULTS, password);
                const decryptedString = decryptedBytes.toString(CryptoJS.enc.Utf8);

                if (!decryptedString) throw new Error("Invalid Password");

                activeDefaults = JSON.parse(decryptedString);

                // Save to LocalStorage for persistence
                localStorage.setItem('cx_secure_config', decryptedString);

                // Success
                document.getElementById('securityModal').classList.add('hidden');
                document.getElementById('loader').classList.remove('hidden');
                initializeDatabaseState();
                startApp();

            } catch (e) {
                alert("Incorrect Password or Corrupted Data.");
                console.error(e);
            }
        }

        function generateEncryptedConfig() {
            const password = document.getElementById('encryptPassword').value;
            if (!password) {
                alert("Please enter a password to encrypt with.");
                return;
            }

            // We encrypt the PLAIN_DEFAULTS object
            // Note: If you have updated URLs in the UI and saved them to DB, 
            // this only encrypts the hardcoded defaults. 
            // To encrypt current state, we'd need to pull from 'database' object.
            // For now, we encrypt the PLAIN_DEFAULTS as requested.

            try {
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(PLAIN_DEFAULTS), password).toString();

                // Format for display
                const output = "// Encrypted with password: \"" + password + "\"\n" +
                    `const SECURE_DEFAULTS = ${JSON.stringify(encrypted)}`;

                const outArea = document.getElementById('encryptOutput');
                const outText = document.getElementById('encryptOutputText');
                outArea.classList.remove('hidden');
                outText.value = output;
                outText.select();
            } catch (e) {
                alert("Encryption failed: " + e.message);
            }
        }

        // ==========================================
        // üì• DATA FETCHING
        // ==========================================
        async function fetchData(regionKey, showLoader = true) {
            const loader = document.getElementById('loader');
            if (showLoader) {
                loader.classList.remove('hidden');
            }

            // Get URL from database state
            const entry = database[regionKey];
            const targetUrl = entry.url && entry.url.trim() !== '' ? entry.url : '';

            // Check for Proxy Setting
            const useProxy = localStorage.getItem('cx_use_proxy') === 'true';

            // Construct Final URL
            const finalUrl = useProxy ? 'https://corsproxy.io/?' + encodeURIComponent(targetUrl) : targetUrl;
            console.log("Attempting to fetch from:", finalUrl);

            try {
                const response = await fetch(finalUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const textData = await response.text();
                let jsonResponse = null;
                let isJson = false;

                // Try parsing as JSON first, regardless of Content-Type
                try {
                    // Optimization: Only try parsing if it looks like JSON
                    if (textData.trim().startsWith('{') || textData.trim().startsWith('[')) {
                        jsonResponse = JSON.parse(textData);
                        isJson = true;
                    }
                } catch (e) {
                    // Not JSON, proceed to CSV
                }

                if (isJson) {
                    console.log("Received JSON response:", jsonResponse);

                    // Smartly find the data array
                    rawData = findDataArray(jsonResponse);

                    // üö® DEBUG CHECK: If 200 OK but no data found, warn the user
                    if (rawData.length === 0) {
                        console.warn("JSON parsed but no array found. Root keys:", Object.keys(jsonResponse));
                        alert(`Connected (200 OK), but could not find a data array.\n\nReceived:\n${JSON.stringify(jsonResponse, null, 2).slice(0, 200)}...`);
                        if (showLoader) {
                            loader.classList.add('hidden');
                        }
                        return;
                    }

                    // Inject Region Tag if provided (for consistency if merged later)
                    if (regionKey !== 'Master') {
                        rawData.forEach(row => row['Country'] = regionKey);
                    }

                    // ‚úÖ Save to Database
                    saveToDatabase(regionKey, rawData, showLoader);
                }
                // Handle CSV (Google Sheets fallback)
                else {
                    Papa.parse(textData, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                            rawData = results.data;

                            if (regionKey !== 'Master') {
                                rawData.forEach(row => row['Country'] = regionKey);
                            }

                            // ‚úÖ Save to Database
                            saveToDatabase(regionKey, rawData, showLoader);
                        }
                    });
                }
            } catch (err) {
                console.error("Error fetching data:", err);
                alert("Fetch Failed: " + err.message);

                if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
                    alert("Connection Failed! This is likely a CORS error.\n\nTry enabling the 'Use CORS Proxy' option in Settings.");
                } else if (err.message.includes('404')) {
                    alert("Error 404: Not Found.\n\nPlease check if the URL is correct and the sheet is public.");
                } else {
                    alert(`Failed to load data: ${err.message}\n\nPlease check the browser console (F12) for more details.`);
                }
                if (showLoader) {
                    loader.classList.add('hidden');
                }
            }
        }

        async function syncAll() {
            const btn = document.getElementById('syncAllBtn');
            const icon = btn.querySelector('i');
            const textSpan = document.getElementById('lastSyncText');

            // UI Loading State
            btn.disabled = true;
            icon.classList.add('fa-spin');
            textSpan.innerText = "Syncing...";

            const regions = [
                'Master',
                'KSA_Widget', 'UAE_Widget', 'ZA_Widget',
                'KSA_Whatsapp', 'UAE_Whatsapp', 'ZA_Whatsapp',
                'Test_Sheet'
            ];

            // Filter to only sync regions that have a valid, non-placeholder URL
            const validRegions = regions.filter(r => {
                const entry = database[r];
                const url = entry.url && entry.url.trim() !== '' ? entry.url : '';
                return url && !url.includes('SPREADSHEET_ID');
            });

            try {
                // Fetch valid regions in background (no full screen loader)
                await Promise.all(validRegions.map(r => fetchData(r, false)));

                // Update Timestamp
                const now = new Date().toLocaleString();
                textSpan.innerText = `Last Sync: ${now}`;
            } catch (error) {
                console.error("Sync All Failed", error);
                textSpan.innerText = "Sync Failed";
            } finally {
                btn.disabled = false;
                icon.classList.remove('fa-spin');
            }
        }

        async function saveToDatabase(region, data, hideLoader = true) {
            database[region].data = data;
            const now = new Date();
            database[region].updated = now.toLocaleString();
            database[region].updatedTs = now.getTime();

            try {
                await dbSaveRegion(region, database[region]);
            } catch (e) {
                console.error("DB Save Error:", e);
                alert("Error saving to database: " + e.message);
            }

            // If we are currently viewing this region, refresh dashboard
            // Check if the updated region matches the current filter criteria
            const currentView = document.getElementById('countryFilter').value;
            const currentSource = document.getElementById('sourceFilter').value;

            const viewKey = currentView === 'All' ? 'Master' : `${currentView}_${currentSource}`;

            if (viewKey === region || currentView === 'All') {
                applyFilters();
            }

            // If settings are open, refresh them
            if (!document.getElementById('settingsModal').classList.contains('hidden')) {
                renderSettingsRows();
            }

            updateLastSyncDisplay();

            if (hideLoader) {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        async function updateRegionUrl(region, newUrl) {
            database[region].url = newUrl;
            try {
                await dbSaveRegion(region, database[region]);
                alert('URL for ' + region + ' saved!'); // Give user feedback
            } catch (e) {
                console.error("Failed to save URL:", e);
                alert('Failed to save URL: ' + e.message);
            }
        }

        async function testRegionUrl(regionKey) {
            const urlInput = document.getElementById('url_' + regionKey);
            const targetUrl = urlInput.value.trim();

            if (!targetUrl) {
                alert("URL is empty.");
                return;
            }

            const useProxy = localStorage.getItem('cx_use_proxy') === 'true';
            const finalUrl = useProxy ? 'https://corsproxy.io/?' + encodeURIComponent(targetUrl) : targetUrl;

            alert(`Testing connection to: ${finalUrl}`);

            try {
                const response = await fetch(finalUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                alert(`Connection successful! The API returned status ${response.status}.`);
            } catch (err) {
                console.error("Test connection failed:", err);
                alert(`Connection failed: ${err.message}`);
            }
        }

        // Helper to find the data array in various JSON structures
        function findDataArray(obj) {
            if (Array.isArray(obj)) {
                // Direct array: [{...}, {...}]
                return obj;
            }

            // 4. Wrapped object: { data: [...] } or { items: [...] }
            if (obj && typeof obj === 'object') {
                if (Array.isArray(obj.data)) return obj.data;
                if (Array.isArray(obj.items)) return obj.items;
                if (Array.isArray(obj.result)) return obj.result;
                // 5. Fallback: Return first array property found
                for (const key in obj) {
                    if (Array.isArray(obj[key])) return obj[key];
                }
            }
            return [];
        }

        // ==========================================
        // üîç FILTER LOGIC
        // ==========================================
        function applyFilters() {
            const countryVal = document.getElementById('countryFilter').value;

            const sourceVal = document.getElementById('sourceFilter').value;
            const startVal = new Date(document.getElementById('startDate').value);
            const endVal = new Date(document.getElementById('endDate').value);
            // End date needs to cover the full day, so set to end of day
            endVal.setHours(23, 59, 59, 999);

            const isCompare = document.getElementById('compareToggle').checked;
            const isCsatOnly = document.getElementById('csatToggle').checked;
            const isTestMode = document.getElementById('testModeToggle').checked;

            // Determine which DB key to use
            if (isTestMode) {
                // Test Mode: Only load Test Sheet
                rawData = database.Test_Sheet ? database.Test_Sheet.data : [];
                document.getElementById('dataStatusText').innerText = `TEST MODE (${rawData.length} rows)`;
                document.getElementById('dataStatusText').className = "text-xs text-accent-red text-center font-bold animate-pulse";
            } else if (countryVal === 'All') {
                // Merge all data

                rawData = [];
                if (sourceVal == "Widget") {
                    rawData = rawData.concat(database.Master.data);
                    rawData = rawData.concat(database.KSA_Widget.data);
                    rawData = rawData.concat(database.UAE_Widget.data);
                    rawData = rawData.concat(database.ZA_Widget.data);

                } else if (sourceVal == "Whatsapp") {
                    rawData = [].concat(
                        database.KSA_Whatsapp.data,
                        database.UAE_Whatsapp.data,
                        database.ZA_Whatsapp.data
                    );
                }
                document.getElementById('dataStatusText').innerText = `Merged View (${rawData.length} rows)`;
                document.getElementById('dataStatusText').className = "text-xs text-accent-blue text-center";
            } else {
                // Specific Region
                const key = `${countryVal}_${sourceVal}`;
                const entry = database[key];

                rawData = entry ? entry.data : [];
                const updated = entry ? entry.updated : 'Never';
                document.getElementById('dataStatusText').innerText = `Loaded: ${countryVal} ${sourceVal} (${updated})`;
                document.getElementById('dataStatusText').className = "text-xs text-accent-green text-center";
            }

            console.log("Raw Data Loaded:", rawData.length, "rows");

            // 1. Main Filter
            filteredData = rawData.filter(row => {
                // Determine row Date (Handle multiple date formats loosely)
                const rowDateStr = row['First message date'] || row['first_message_date'] || '';
                const rowDate = new Date(rowDateStr);

                // Determine Country (Assuming 'Region' or inferring from filename if mapped in sheet)
                // Note: If you don't have a 'Country' column in your specific CSV, 
                // you might need to add one or rely on separate sheets. 
                // For this demo, we'll assume ALL data is present or handle filtering if column exists.
                // If your sheet combines countries, ensure there's a 'Country' or 'Region' column.
                const rowCountry = row['Country'] || 'All';

                // Date Check
                const dateValid = rowDate >= startVal && rowDate <= endVal;

                // Country Check (Only if column exists, otherwise ignore)
                const countryValid = (countryVal === 'All') ? true : (rowCountry === countryVal || rowCountry.startsWith(countryVal));

                // CSAT Check
                let csatValid = true;
                if (isCsatOnly) {
                    const c = parseInt(row['C-sat']);
                    csatValid = !isNaN(c) && c >= 1 && c <= 5;
                }

                return dateValid && countryValid && csatValid;
            });

            console.log("Filtered Data:", filteredData.length);

            // 2. Previous Period Data (For Comparison)
            let prevData = [];
            if (isCompare) {
                const dayDiff = (endVal - startVal) / (1000 * 60 * 60 * 24);
                const prevStart = new Date(startVal);
                prevStart.setDate(prevStart.getDate() - dayDiff);
                const prevEnd = new Date(startVal);

                prevData = rawData.filter(row => {
                    const rDate = new Date(row['First message date']);
                    return rDate >= prevStart && rDate < prevEnd;
                });
            }

            updateKPIs(filteredData, prevData, isCompare);
            updateCharts(filteredData);
            updateAnalysis(filteredData);

            saveDashboardState(); // Persist state on every filter change
        }

        // ==========================================
        // üìä VISUALIZATION UPDATE
        // ==========================================
        function updateKPIs(data, prevData, isCompare) {
            const total = data.length;
            const prevTotal = prevData.length;

            // 1. Total Volume
            const kpiVol = document.getElementById('kpiTotalVolume');
            const kpiTrend = document.getElementById('trendVolume');

            kpiVol.innerText = total.toLocaleString();

            if (isCompare && prevTotal > 0) {
                const diff = total - prevTotal;
                const pct = ((diff / prevTotal) * 100).toFixed(1);
                const color = diff >= 0 ? 'text-accent-green' : 'text-accent-red';
                const icon = diff >= 0 ? '‚Üë' : '‚Üì';
                kpiTrend.innerHTML = `<span class="${color}">${icon} ${Math.abs(pct)}%</span> vs previous period`;
            } else {
                kpiTrend.innerHTML = `<span class="text-gray-500">Select comparison to see trends</span>`;
            }

            // 2. Escalation Rate
            const escalated = data.filter(r => (r['Requested Agent'] || '').toLowerCase() === 'yes').length;
            const escRate = total > 0 ? ((escalated / total) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('kpiEscalation').innerText = escRate;

            // 3. Sentiment
            const positive = data.filter(r => (r['Sentiment'] || '').toLowerCase() === 'positive').length;
            const negative = data.filter(r => (r['Sentiment'] || '').toLowerCase() === 'negative').length;
            const neutral = total - positive - negative;

            if (total > 0) {
                const pPct = ((positive / total) * 100).toFixed(0) + '%';
                const nPct = ((negative / total) * 100).toFixed(0) + '%';
                const uPct = ((neutral / total) * 100).toFixed(0) + '%';

                document.getElementById('barPositive').style.width = pPct;
                document.getElementById('barNegative').style.width = nPct;
                document.getElementById('barNeutral').style.width = uPct;

                document.getElementById('valPositive').innerText = pPct;
                document.getElementById('valNegative').innerText = nPct;
                document.getElementById('valNeutral').innerText = uPct;
            } else {
                document.getElementById('barPositive').style.width = '0%';
                document.getElementById('barNegative').style.width = '0%';
                document.getElementById('barNeutral').style.width = '0%';
            }

            // 4. Avg Bot Messages
            let msgSum = 0;
            let countWithMsg = 0;
            data.forEach(r => {
                const msgs = parseInt(r['alhena_msgs']);
                if (!isNaN(msgs)) {
                    msgSum += msgs;
                    countWithMsg++;
                }
            });
            const avg = countWithMsg > 0 ? (msgSum / countWithMsg).toFixed(1) : '-';
            document.getElementById('kpiAvgMsgs').innerText = avg;

            // 5. CSAT
            const csatScores = data
                .map(r => parseInt(r['C-sat']))
                .filter(n => !isNaN(n) && n >= 1 && n <= 5);

            const avgCsat = csatScores.length > 0
                ? (csatScores.reduce((a, b) => a + b, 0) / csatScores.length).toFixed(1)
                : '-';

            const responseRate = total > 0
                ? ((csatScores.length / total) * 100).toFixed(1) + '%'
                : '0%';

            document.getElementById('kpiAvgCsat').innerText = avgCsat;
            document.getElementById('csatResponseRate').innerText = `Response Rate: ${responseRate}`;

            // 6. Deeper Issue Analysis KPIs
            const isValid = (val) => val && val.toLowerCase() !== 'na' && val.toLowerCase() !== 'false' && val.trim() !== '';

            const botIssueCount = data.filter(r => isValid(getValueFuzzy(r, 'Bot category'))).length;
            const websiteIssueCount = data.filter(r => isValid(getValueFuzzy(r, 'website issue category'))).length;
            const reasonNotBuyingCount = data.filter(r => isValid(getValueFuzzy(r, 'reason_not_buying_category'))).length;
            const angryReasonCount = data.filter(r => isValid(getValueFuzzy(r, 'anger_category'))).length;
            const deviceQualityCount = data.filter(r => isValid(getValueFuzzy(r, 'device_quality_category'))).length;
            const pricingTopicCount = data.filter(r => isValid(getValueFuzzy(r, 'pricing_category'))).length;

            const formatKpi = (count) => {
                const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                return `${count.toLocaleString()} <span class="text-sm text-gray-400 font-normal">(${pct}%)</span>`;
            };

            document.getElementById('kpiBotIssues').innerHTML = formatKpi(botIssueCount);
            document.getElementById('kpiWebsiteIssue').innerHTML = formatKpi(websiteIssueCount);
            document.getElementById('kpiReasonNotBuying').innerHTML = formatKpi(reasonNotBuyingCount);
            document.getElementById('kpiAngryReason').innerHTML = formatKpi(angryReasonCount);
            document.getElementById('kpiDeviceQuality').innerHTML = formatKpi(deviceQualityCount);
            document.getElementById('kpiPricingTopic').innerHTML = formatKpi(pricingTopicCount);

            // Update Top 4 Lists in Cards
            updateCardTopCategories(data, 'Bot category', 'listBotIssues', 'bg-gray-400');
            updateCardTopCategories(data, 'website issue category', 'listWebsiteIssues', 'bg-accent-yellow');
            updateCardTopCategories(data, 'reason_not_buying_category', 'listReasonNotBuying', 'bg-accent-red');
            updateCardTopCategories(data, 'anger_category', 'listAngryReason', 'bg-accent-purple');
            updateCardTopCategories(data, 'device_quality_category', 'listDeviceQuality', 'bg-accent-green');
            updateCardTopCategories(data, 'pricing_category', 'listPricingTopic', 'bg-accent-blue');
        }

        function updateCharts(data) {
            // Helper: Group By Date
            const volByDate = {};
            data.forEach(r => {
                const dStr = r['First message date']; // Format: 2025-11-26 14:19:58
                if (dStr) {
                    const shortDate = dStr.split(' ')[0]; // 2025-11-26
                    volByDate[shortDate] = (volByDate[shortDate] || 0) + 1;
                }
            });

            // Sort Dates
            const sortedDates = Object.keys(volByDate).sort();
            const volData = sortedDates.map(d => volByDate[d]);

            // Helper: Group by Category
            const catCounts = {};
            data.forEach(r => {
                const c = r['Primary Category'] || 'Uncategorized';
                catCounts[c] = (catCounts[c] || 0) + 1;
            });

            // Helper: Group by Intent
            const intentCounts = {};
            data.forEach(r => {
                const i = r['Intent'] || 'Unknown';
                intentCounts[i] = (intentCounts[i] || 0) + 1;
            });
            // Sort intents and take top 5
            const sortedIntents = Object.entries(intentCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);


            // --- RENDER CHARTS ---
            destroyChart('volumeChart');
            destroyChart('categoryChart');
            destroyChart('intentChart');
            destroyChart('csatChart');
            destroyChart('issuesLandscapeChart');

            // 1. Line Chart
            const ctx1 = document.getElementById('volumeChart').getContext('2d');
            charts['volumeChart'] = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Tickets',
                        data: volData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: getChartOptions('line')
            });

            // 2. Category Doughnut
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            charts['categoryChart'] = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catCounts),
                    datasets: [{
                        data: Object.values(catCounts),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ef4444', '#10b981', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: getChartOptions('doughnut')
            });

            // 3. Top Intents Horizontal Bar
            const ctx3 = document.getElementById('intentChart').getContext('2d');
            charts['intentChart'] = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: sortedIntents.map(x => x[0]),
                    datasets: [{
                        label: 'Count',
                        data: sortedIntents.map(x => x[1]),
                        backgroundColor: '#f59e0b',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    ...getChartOptions('bar')
                }
            });

            // 4. CSAT vs Sentiment Stacked Bar
            const sentimentOrder = ['Negative', 'Neutral', 'Positive'];
            const csatBuckets = {
                'Negative': [0, 0, 0, 0, 0],
                'Neutral': [0, 0, 0, 0, 0],
                'Positive': [0, 0, 0, 0, 0]
            };

            data.forEach(r => {
                const s = r['Sentiment'] || 'Neutral';
                const c = parseInt(r['C-sat']);
                if (sentimentOrder.includes(s) && !isNaN(c) && c >= 1 && c <= 5) {
                    csatBuckets[s][c - 1]++; // c-1 because array is 0-indexed (Score 1 = index 0)
                }
            });

            const csatDatasets = [
                { label: '1 Star', data: sentimentOrder.map(s => csatBuckets[s][0]), backgroundColor: '#ef4444' },
                { label: '2 Stars', data: sentimentOrder.map(s => csatBuckets[s][1]), backgroundColor: '#f97316' },
                { label: '3 Stars', data: sentimentOrder.map(s => csatBuckets[s][2]), backgroundColor: '#eab308' },
                { label: '4 Stars', data: sentimentOrder.map(s => csatBuckets[s][3]), backgroundColor: '#84cc16' },
                { label: '5 Stars', data: sentimentOrder.map(s => csatBuckets[s][4]), backgroundColor: '#22c55e' }
            ];

            const ctx4 = document.getElementById('csatChart').getContext('2d');
            charts['csatChart'] = new Chart(ctx4, {
                type: 'bar',
                data: { labels: sentimentOrder, datasets: csatDatasets },
                options: {
                    ...getChartOptions('bar'),
                    scales: {
                        x: { stacked: true, ticks: { color: '#94a3b8' }, grid: { display: false } },
                        y: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                    }
                }
            });

            // 5. Issues Landscape (Polar Area)
            // Recalculate counts for chart consistency
            const isValid = (val) => val && val.toLowerCase() !== 'na' && val.toLowerCase() !== 'false' && val.trim() !== '';
            const issueCounts = [
                data.filter(r => isValid(getValueFuzzy(r, 'Bot category'))).length,
                data.filter(r => isValid(getValueFuzzy(r, 'website issue category'))).length,
                data.filter(r => isValid(getValueFuzzy(r, 'reason_not_buying_category'))).length,
                data.filter(r => isValid(getValueFuzzy(r, 'anger_category'))).length,
                data.filter(r => isValid(getValueFuzzy(r, 'device_quality_category'))).length,
                data.filter(r => isValid(getValueFuzzy(r, 'pricing_category'))).length
            ];

            const ctx5 = document.getElementById('issuesLandscapeChart').getContext('2d');
            charts['issuesLandscapeChart'] = new Chart(ctx5, {
                type: 'polarArea',
                data: {
                    labels: ['Bot Issues', 'Website Issues', 'Reason Not Buying', 'Angry Customers', 'Device Quality', 'Pricing Issues'],
                    datasets: [{
                        data: issueCounts,
                        backgroundColor: [
                            'rgba(156, 163, 175, 0.6)', // Gray (Bot)
                            'rgba(245, 158, 11, 0.6)',  // Yellow (Website)
                            'rgba(239, 68, 68, 0.6)',   // Red (Buying)
                            'rgba(139, 92, 246, 0.6)',  // Purple (Angry)
                            'rgba(16, 185, 129, 0.6)',  // Green (Quality)
                            'rgba(59, 130, 246, 0.6)'   // Blue (Pricing)
                        ],
                        borderWidth: 1,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            grid: { color: '#334155' },
                            ticks: { display: false, backdropColor: 'transparent' },
                            pointLabels: { color: '#cbd5e1', font: { size: 11 } }
                        }
                    },
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function updateCardTopCategories(data, column, elementId, colorClass) {
            const container = document.getElementById(elementId);
            if (!container) return;

            const counts = {};
            let total = 0;

            data.forEach(r => {
                const val = getValueFuzzy(r, column);
                if (val && val.toLowerCase() !== 'na' && val.toLowerCase() !== 'false' && val.trim() !== '') {
                    counts[val] = (counts[val] || 0) + 1;
                    total++;
                }
            });

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 4);

            let html = '<div class="space-y-2 mt-3">';
            sorted.forEach(([key, count]) => {
                const pct = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                html += `
                    <div>
                        <div class="flex justify-between items-center text-[10px] mb-0.5">
                            <span class="text-gray-300 truncate pr-2" title="${key}">${key}</span>
                            <span class="text-gray-400 font-mono">${pct}%</span>
                        </div>
                        <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                            <div class="${colorClass} h-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = sorted.length > 0 ? html : '';
        }

        function updateMiniKPIChart(canvasId, count, total, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
            const remaining = total - count;

            if (charts[canvasId]) {
                charts[canvasId].data.datasets[0].data = [count, remaining];
                charts[canvasId].data.datasets[0].backgroundColor[0] = color;
                charts[canvasId].options.centerText = percentage + "%";
                charts[canvasId].update();
                return;
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['With Issue', 'Others'],
                    datasets: [{
                        data: [count, remaining],
                        backgroundColor: [color, 'rgba(255, 255, 255, 0.05)'],
                        borderWidth: 0,
                        borderRadius: 2
                    }]
                },
                options: {
                    centerText: percentage + "%",
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: { duration: 500 }
                },
                plugins: [{
                    id: 'textCenter',
                    beforeDraw: function (chart) {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;

                        ctx.restore();
                        const fontSize = (height / 50).toFixed(2);
                        ctx.font = "bold " + fontSize + "em sans-serif";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#94a3b8";

                        const text = chart.options.centerText;
                        const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        const textY = height / 2;

                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });
        }

        function updateAnalysis(data) {
            // 2. Actionable Recommendations
            const recMap = {};
            const negativeTickets = data.filter(r => (r['Sentiment'] || '').toLowerCase() === 'negative');
            negativeTickets.forEach(r => {
                const rec = r['Recommendation'];
                if (rec && rec !== 'null' && rec !== 'empty') {
                    recMap[rec] = (recMap[rec] || 0) + 1;
                }
            });

            // Store globally for modal
            currentRecommendations = Object.entries(recMap).sort((a, b) => b[1] - a[1]);

            // Display Top 5
            const topRecs = currentRecommendations.slice(0, 5);

            const recContainer = document.getElementById('recommendationsGrid');
            recContainer.innerHTML = '';

            const iconMap = {
                'Priority Agent Callback': 'fa-phone-volume',
                'Logistics Investigation': 'fa-truck-fast',
                'Initiate Return/Exchange': 'fa-rotate',
                'Offer Discount Voucher': 'fa-ticket'
            };

            topRecs.forEach(([rec, count]) => {
                const icon = iconMap[rec] || 'fa-clipboard-check';
                const html = `
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-lg border border-slate-700 text-center">
                        <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-accent-purple">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <h4 class="text-sm font-bold text-gray-200 mb-1">${rec}</h4>
                    </div>
                `;
                recContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // ==========================================
        // üí° RECOMMENDATIONS MODAL LOGIC
        // ==========================================
        function openRecommendationsModal() {
            const modal = document.getElementById('recommendationsModal');
            const list = document.getElementById('recommendationsModalList');
            list.innerHTML = '';

            // Reset Summary
            document.getElementById('recSummaryContainer').classList.add('hidden');
            document.getElementById('recSummaryText').innerHTML = '';

            if (currentRecommendations.length === 0) {
                list.innerHTML = '<p class="text-gray-500 italic">No recommendations available.</p>';
            } else {
                // Show top 10
                const top10 = currentRecommendations.slice(0, 10);

                const iconMap = {
                    'Priority Agent Callback': 'fa-phone-volume',
                    'Logistics Investigation': 'fa-truck-fast',
                    'Initiate Return/Exchange': 'fa-rotate',
                    'Offer Discount Voucher': 'fa-ticket'
                };

                top10.forEach(([rec, count]) => {
                    const icon = iconMap[rec] || 'fa-clipboard-check';
                    const html = `
                        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 flex items-center gap-4">
                            <div class="w-10 h-10 bg-slate-700 rounded-full flex-shrink-0 flex items-center justify-center text-accent-purple">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-white">${rec}</h4>
                                <p class="text-xs text-gray-500">Suggested in ${count} tickets</p>
                            </div>
                        </div>
                    `;
                    list.insertAdjacentHTML('beforeend', html);
                });
            }

            modal.classList.remove('hidden');
        }

        async function generateRecommendationsSummary() {
            const container = document.getElementById('recSummaryContainer');
            const textArea = document.getElementById('recSummaryText');

            container.classList.remove('hidden');
            textArea.innerHTML = '<div class="flex items-center gap-2 text-gray-400"><i class="fa-solid fa-circle-notch fa-spin"></i> Generating summary...</div>';

            const apiKey = localStorage.getItem('cx_gemini_key');
            if (!apiKey) {
                textArea.innerHTML = '<span class="text-accent-red">API Key missing. Please set it in AI Analyst or Settings.</span>';
                return;
            }

            const recsText = currentRecommendations.slice(0, 15).map(([r, c]) => `- ${r} (${c} times)`).join('\n');

            const prompt = `
                You are a CX Strategist. Summarize the following list of AI-generated recommendations derived from customer tickets.
                Provide a cohesive summary of the strategic actions needed.
                
                Recommendations Data:
                ${recsText}
                
                Output: A concise paragraph (max 4 sentences) summarizing the key actions the company should take.
            `;

            try {
                const model = "gemini-2.5-flash";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    textArea.innerHTML = `<h5 class="text-xs font-bold text-accent-purple mb-2 flex items-center gap-2"><i class="fa-solid fa-robot"></i> AI Summary</h5>` + text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>');
                } else {
                    throw new Error("No response text");
                }
            } catch (e) {
                console.error(e);
                textArea.innerHTML = `<span class="text-accent-red">Analysis failed: ${e.message}</span>`;
            }
        }

        // ==========================================
        // üíæ STATE PERSISTENCE
        // ==========================================
        const STATE_KEY = 'cx_dashboard_state';
        const ISSUES_KEY_PREFIX = 'cx_issues_';

        function saveDashboardState() {
            const state = {
                country: document.getElementById('countryFilter').value,
                source: document.getElementById('sourceFilter').value,
                start: document.getElementById('startDate').value,
                end: document.getElementById('endDate').value,
                compare: document.getElementById('compareToggle').checked,
                csat: document.getElementById('csatToggle').checked
            };
            localStorage.setItem(STATE_KEY, JSON.stringify(state));
        }

        function loadDashboardState() {
            const raw = localStorage.getItem(STATE_KEY);
            if (raw) {
                try {
                    const state = JSON.parse(raw);
                    if (state.country) document.getElementById('countryFilter').value = state.country;
                    if (state.source) document.getElementById('sourceFilter').value = state.source;
                    if (state.start) document.getElementById('startDate').value = state.start;
                    if (state.end) document.getElementById('endDate').value = state.end;
                    if (state.compare !== undefined) document.getElementById('compareToggle').checked = state.compare;
                    if (state.csat !== undefined) document.getElementById('csatToggle').checked = state.csat;
                    return true;
                } catch (e) {
                    console.error("Failed to load dashboard state", e);
                }
            }
            return false;
        }

        // ==========================================
        // üõ†Ô∏è CHART UTILS
        // ==========================================
        function getChartOptions(type) {
            const base = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8', font: { size: 10 } }
                    }
                },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { display: false } },
                    y: { ticks: { color: '#64748b' }, grid: { color: '#334155' }, beginAtZero: true }
                }
            };

            if (type === 'doughnut') {
                delete base.scales;
            }
            return base;
        }

        function destroyChart(id) {
            if (charts[id]) {
                charts[id].destroy();
            }
        }

        // ==========================================
        // ‚öôÔ∏è SETTINGS LOGIC
        // ==========================================
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            if (!modal) {
                alert('Settings module is still loading. Please wait a moment and try again.');
                return;
            }

            const proxyCheck = document.getElementById('settingsCorsProxy');
            proxyCheck.checked = localStorage.getItem('cx_use_proxy') === 'true';

            renderSettingsRows();
            modal.classList.remove('hidden');
        }

        function renderSettingsRows() {
            const container = document.getElementById('dataManagerRows');
            container.innerHTML = '';

            const regions = [
                { code: 'Master', label: 'Global / Master (Widget Only)', keys: ['Master'] },
                { code: 'KSA', label: 'Saudi Arabia (KSA)', keys: ['KSA_Widget', 'KSA_Whatsapp'] },
                { code: 'UAE', label: 'UAE', keys: ['UAE_Widget', 'UAE_Whatsapp'] },
                { code: 'ZA', label: 'South Africa (ZA)', keys: ['ZA_Widget', 'ZA_Whatsapp'] },
                { code: 'Test', label: 'Test Sheet (Debug)', keys: ['Test_Sheet'] }
            ];

            regions.forEach(reg => {
                let rowsHtml = '';

                reg.keys.forEach(key => {
                    const dbEntry = database[key];
                    const count = dbEntry.data.length;
                    const lastUpd = dbEntry.updated;
                    const currentUrl = dbEntry.url;
                    const statusColor = count > 0 ? 'text-accent-green' : 'text-gray-500';
                    const label = key.includes('_Whatsapp') ? 'Whatsapp' : (key === 'Master' ? 'Master Sheet' : 'Chat Widget');

                    rowsHtml += `
                        <div class="flex gap-2 items-center mt-2 first:mt-0">
                            <span class="text-xs text-gray-400 w-20">${label}</span>
                            <input type="text" id="url_${key}" value="${currentUrl}" placeholder="https://..." 
                                class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-xs text-white focus:border-accent-blue outline-none">
                            
                            <button onclick="testRegionUrl('${key}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="Test Connection">
                                <i class="fa-solid fa-flask"></i>
                            </button>
                            <button onclick="updateRegionUrl('${key}', document.getElementById('url_${key}').value)"
                                class="bg-accent-green hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="Save URL">
                                <i class="fa-solid fa-save"></i>
                            </button>
                            <button onclick="fetchData('${key}')" 
                                class="bg-accent-blue hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="Sync Data">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                            <span class="text-[10px] ${statusColor} w-24 text-right">${count} Rows<br>${lastUpd.split(',')[0]}</span>
                        </div>
                    `;
                });

                const html = `
                    <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-sm text-white">${reg.label}</h4>
                        </div>
                        ${rowsHtml}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function closeSettings() {
            // Save proxy setting
            const proxyCheck = document.getElementById('settingsCorsProxy');
            localStorage.setItem('cx_use_proxy', proxyCheck.checked);
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // ==========================================
        // üìÇ REPORTS ARCHIVE LOGIC
        // ==========================================
        let savedReports = [];

        async function openReportsArchive() {
            const modal = document.getElementById('reportsArchiveModal');
            if (!modal) {
                alert('Reports Archive is still loading. Please wait a moment and try again.');
                return;
            }

            try {
                savedReports = await dbLoadAllRegionsReports();
                renderReportsList();
                document.getElementById('reportsArchiveModal').classList.remove('hidden');
            } catch (e) {
                console.error("Could not open reports archive:", e);
                alert("Error loading reports: " + e.message);
            }
        }

        function closeReportsArchive() {
            document.getElementById('reportsArchiveModal').classList.add('hidden');
        }

        function renderReportsList() {
            const listEl = document.getElementById('reportsList');
            listEl.innerHTML = ''; // Clear existing list

            if (!savedReports || savedReports.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-sm italic">No reports saved yet.</p>';
                return;
            }

            // Sort reports, newest first
            const sorted = savedReports.sort((a, b) => b.savedAt - a.savedAt);

            sorted.forEach(report => {
                let title = `Analysis for ${report.context.region}`;
                if (report.context.type === 'Category Summary') {
                    title = `Summary: ${report.context.category}`;
                }
                const date = new Date(report.savedAt).toLocaleString();
                const html = `
                    <div class="p-3 rounded-lg hover:bg-slate-700 border-b border-slate-800 flex items-center gap-3 group transition-colors">
                        <input type="checkbox" class="report-checkbox rounded bg-slate-800 border-slate-600 focus:ring-accent-blue cursor-pointer" value="${report.id}">
                        <div onclick="displayReport(${report.id})" class="cursor-pointer flex-1">
                            <p class="font-bold text-sm text-white truncate">${title}</p>
                            <p class="text-xs text-gray-400">${date}</p>
                        </div>
                        <button onclick="deleteReport(${report.id}); event.stopPropagation();" class="text-gray-500 hover:text-accent-red opacity-0 group-hover:opacity-100 transition-opacity px-2" title="Delete Report">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', html);
            });
        }

        function toggleSelectAllReports(source) {
            const checkboxes = document.querySelectorAll('.report-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function downloadSelectedReports() {
            const checkboxes = document.querySelectorAll('.report-checkbox:checked');
            if (checkboxes.length === 0) return alert("Please select at least one report to download.");

            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const reportsToDownload = savedReports.filter(r => selectedIds.includes(r.id));

            const dataStr = JSON.stringify(reportsToDownload, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `cx_reports_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function displayReport(reportId) {
            const detailView = document.getElementById('reportDetailView');
            const report = savedReports.find(r => r.id === reportId);

            if (!report) {
                detailView.innerHTML = '<p class="text-accent-red">Report not found.</p>';
                return;
            }

            const context = report.context;
            let title = `Report for ${context.region} (${context.dateRange.start} to ${context.dateRange.end})`;
            if (context.type === 'Category Summary') {
                title = `Category Summary: ${context.category}`;
            }

            const html = `
                <div class="prose prose-invert max-w-none">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-lg font-bold text-white">${title}</h2>
                         <button onclick="deleteReport(${report.id})" class="text-gray-400 hover:text-accent-red transition-colors text-xs py-1 px-2 rounded hover:bg-slate-700">
                            <i class="fa-solid fa-trash"></i> Delete
                         </button>
                    </div>
                    <p class="text-xs text-gray-500">Saved on ${new Date(report.savedAt).toLocaleString()}</p>
                    <hr class="border-slate-600 my-4"/>
                    ${report.htmlContent}
                </div>
            `;
            detailView.innerHTML = html;
        }

        async function deleteReport(reportId) {
            if (!confirm("Are you sure you want to delete this report forever?")) {
                return;
            }

            try {
                const db = await initDB();
                await new Promise((resolve, reject) => {
                    const tx = db.transaction(IDB_STORE_REPORTS, 'readwrite');
                    const store = tx.objectStore(IDB_STORE_REPORTS);
                    store.delete(reportId);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });

                // Refresh the view
                document.getElementById('reportDetailView').innerHTML = '<p class="text-gray-500">Report deleted.</p>';
                await openReportsArchive(); // Reload and render list

            } catch (e) {
                console.error("Failed to delete report:", e);
                alert("Error deleting report: " + e.message);
            }
        }

        // ==========================================
        // ü§ñ AI ANALYST LOGIC
        // ==========================================
        let aiLogContent = '';

        function aiLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;

            aiLogContent += logMessage + '\n';
            if (data) {
                // Pretty print JSON for readability in the log
                const formattedData = JSON.stringify(data, null, 2);
                aiLogContent += formattedData + '\n';
                console.log(logMessage, data);
            } else {
                console.log(logMessage);
            }

            const logArea = document.getElementById('aiLogArea');
            if (logArea) {
                logArea.textContent = aiLogContent;
                // Scroll to the bottom of the log
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        function groupAndCount(data, key) {
            if (!key) return {};
            return data.reduce((acc, row) => {
                const value = row[key] || 'Unspecified';
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {});
        }

        function openAIModal() {
            const modal = document.getElementById('aiModal');
            if (!modal) {
                alert('AI Analyst module is still loading. Please wait a moment and try again.');
                return;
            }

            const keySection = document.getElementById('apiKeySection');
            const resultArea = document.getElementById('aiResultArea');
            const savedKey = localStorage.getItem('cx_gemini_key');

            // Reset UI
            resultArea.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-500">
                    <i class="fa-solid fa-wand-magic-sparkles text-4xl mb-4 opacity-50"></i>
                    <p>Ready to analyze the current dashboard view.</p>
                    <p class="text-xs mt-2">Selected Range: <span id="aiDateRange" class="text-gray-300">...</span></p>
                    <button onclick="generateAIReport()"
                        class="mt-6 bg-gradient-to-r from-accent-purple to-indigo-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition-transform">
                        Generate Insight Report
                    </button>
                </div>
            `;


            // Update Date Range Text
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const region = document.getElementById('countryFilter').value;
            document.getElementById('aiDateRange').innerText = `${region} (${start} to ${end})`;

            if (!savedKey) {
                keySection.classList.remove('hidden');
            } else {
                keySection.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        // Ticket Intelligence Modal Controls
        function openTicketIntelligenceModal() {
            const modal = document.getElementById('ticketIntelligenceModal');
            if (!modal) {
                alert('Ticket Intelligence module is still loading. Please wait a moment and try again.');
                return;
            }
            modal.classList.remove('hidden');
            // Trigger init if available
            if (window.initTicketIntelligence) window.initTicketIntelligence();
        }



        function closeTicketIntelligenceModal() {
            document.getElementById('ticketIntelligenceModal').classList.add('hidden');
        }

        function saveApiKey() {
            const key = document.getElementById('geminiApiKey').value.trim();
            if (key) {
                localStorage.setItem('cx_gemini_key', key);
                document.getElementById('apiKeySection').classList.add('hidden');
                alert("API Key Saved!");
            }
        }

        function clearApiKey() {
            localStorage.removeItem('cx_gemini_key');
            document.getElementById('apiKeySection').classList.remove('hidden');
            document.getElementById('geminiApiKey').value = '';
        }

        async function generateAIReport() {
            const apiKey = localStorage.getItem('cx_gemini_key');
            if (!apiKey) {
                alert("Please enter your Gemini API Key first.");
                document.getElementById('apiKeySection').classList.remove('hidden');
                return;
            }

            // Reset state
            currentReport = { html: '', text: '' };
            currentAggregatedData = {};
            const resultArea = document.getElementById('aiResultArea');

            // Setup logging UI
            aiLogContent = ''; // Reset log
            resultArea.innerHTML = `
                <div class="h-full flex flex-col">
                    <div id="aiFinalReport" class="flex-1 overflow-y-auto">
                         <div class="flex flex-col items-center justify-center h-full">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent-purple mb-4"></div>
                            <p class="text-accent-purple animate-pulse">AI analysis in progress...</p>
                        </div>
                    </div>
                    <div id="aiReportActions" class="flex justify-end gap-2 mt-2 pt-2 border-t border-slate-700"></div>
                    <div class="mt-2 border-t border-slate-600 pt-2">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Analysis Log</h4>
                        <pre id="aiLogArea" class="text-xs text-gray-500 bg-slate-900 p-2 rounded h-24 overflow-y-auto"></pre>
                    </div>
                </div>
            `;

            // 1. Aggregate Data
            aiLog("Booting up AI Analyst...");
            aiLog(`Analyzing ${filteredData.length} tickets.`);

            aiLog("Aggregating and summarizing ticket data...");
            const categorySummary = groupAndCount(filteredData, 'Primary Category');
            const intentSummary = groupAndCount(filteredData, 'Intent');
            const negativeTickets = filteredData.filter(r => (r['Sentiment'] || '').toLowerCase() === 'negative');
            const negativeReasonsSummary = groupAndCount(negativeTickets, 'Reason');
            aiLog("Data summarization complete.");

            currentAggregatedData = {
                totalTickets: filteredData.length,
                ticketsByCategory: categorySummary,
                ticketsByIntent: intentSummary,
                totalNegativeTickets: negativeTickets.length,
                reasonsForNegativeSentiment: negativeReasonsSummary
            };

            // 2. Construct Prompt
            aiLog("Constructing expanded prompt for Gemini...");
            const prompt = `
                You are a world-class Senior Customer Experience (CX) Analyst, known for your sharp insights and clear, actionable reports.
                Analyze the following summary of customer support tickets for a comprehensive report.

                CONTEXT:
                - Report for Region: ${document.getElementById('countryFilter').value}
                - Date Range: ${document.getElementById('startDate').value} to ${document.getElementById('endDate').value}

                AGGREGATED DATA (JSON):
                ${JSON.stringify(currentAggregatedData, null, 2)}

                TASK:
                Generate a detailed, well-structured report in Markdown format. The report must include the following sections:

                1.  **Overall CX Health Score**: Provide a single score from 1-100 (1=critical, 100=excellent) representing the overall customer experience health in this period. Justify the score in one sentence.
                
                2.  **Executive Summary**: A brief, high-level paragraph summarizing the key findings. What is the main story this data tells?

                3.  **Key Metrics Snapshot**: Present a Markdown table of the most critical metrics from the data.
                    | Metric                        | Value |
                    | ----------------------------- | ----- |
                    | Total Tickets                 | ...   |
                    | Total Negative Tickets        | ...   |
                    | Negative Ticket %             | ...   |
                    | Top Contact Category & Count  | ...   |
                    | Top Contact Intent & Count    | ...   |

                4.  **Deep Dive: Top 3 Drivers of Negative CX**:
                    - Identify the top 3 reasons for negative sentiment from the 'reasonsForNegativeSentiment' data.
                    - For each reason, provide a brief analysis. What is the likely customer impact? Why is this happening?
                    - Use bullet points for clarity.

                5.  **Strategic & Actionable Recommendations**:
                    - Based *only* on the analysis of negative drivers, provide 3 strategic, actionable recommendations.
                    - For each recommendation, specify the expected outcome (e.g., "Reduce 'defective item' complaints by X%").
                    - Format as a numbered list.
            `;
            aiLog("Prompt construction complete. Sending to API.");

            let attempts = 0;
            let success = false;
            const maxAttempts = 3;
            const model = "gemini-2.5-flash"; // Directly use the correct model here

            while (attempts < maxAttempts && !success) {
                attempts++;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        const errorMessage = data.error?.message || JSON.stringify(data);
                        console.error("Error from proxy/Google API:", data);
                        throw new Error(errorMessage);
                    }

                    if (data?.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const rawText = data.candidates[0].content.parts[0].text;

                        // Simple Markdown Formatting for display
                        const formattedText = rawText
                            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                            .replace(/^# (.*$)/gm, '<h1 class="text-xl font-bold text-accent-purple mt-4 mb-2">$1</h1>')
                            .replace(/^## (.*$)/gm, '<h2 class="text-lg font-bold text-white mt-3 mb-2">$1</h2>')
                            .replace(/^### (.*$)/gm, '<h3 class="text-md font-semibold text-gray-200 mt-2 mb-1">$1</h3>')
                            .replace(/^\* (.*$)/gm, '<li class="ml-4 list-disc">$1</li>')
                            .replace(/\|/g, ' | ') // Add spacing to tables for better rendering
                            .replace(/---/g, '---');

                        const reportContainer = document.getElementById('aiFinalReport');
                        reportContainer.innerHTML = `<div class="prose prose-invert max-w-none">${formattedText}</div>`;

                        // Store for saving/copying
                        currentReport.html = reportContainer.innerHTML;
                        currentReport.text = reportContainer.innerText;

                        aiLog("Report generated successfully!");

                        // Add action buttons
                        const actionsContainer = document.getElementById('aiReportActions');
                        actionsContainer.innerHTML = `
                            <button onclick="copyReport()" class="bg-slate-600 hover:bg-slate-700 text-white px-3 py-1 rounded text-xs font-medium">
                                <i class="fa-solid fa-copy"></i> Copy Report
                            </button>
                            <button onclick="saveReport()" class="bg-accent-blue hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium">
                                <i class="fa-solid fa-save"></i> Save Report
                            </button>
                        `;
                        success = true;

                    } else {
                        console.error("Unexpected API response:", data);
                    }
                } catch (error) {
                    aiLog(`Attempt ${attempts} failed: ${error.message}`);
                    if (attempts >= maxAttempts) {
                        const reportContainer = document.getElementById('aiFinalReport');
                        reportContainer.innerHTML = `<div class="text-accent-red p-4">
                            <h3 class="font-bold">Analysis Failed</h3>
                            <p>Could not connect to the AI service after multiple attempts.</p>
                            <p class="text-xs mt-2"><b>Error:</b> ${error.message}</p>
                            <p class="text-xs mt-2">Please check your API key, internet connection, and the log for details.</p>
                        </div>`;
                    }
                }
            }
        }


        function copyReport() {
            if (currentReport.text) {
                navigator.clipboard.writeText(currentReport.text).then(() => {
                    alert('Report copied to clipboard!');
                }, (err) => {
                    alert('Failed to copy report.');
                    console.error('Copy failed', err);
                });
            }
        }

        async function saveReport() {
            if (!currentReport.html) {
                alert("No report to save.");
                return;
            }

            const region = document.getElementById('countryFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            const reportData = {
                htmlContent: currentReport.html,
                context: {
                    region: region,
                    dateRange: { start, end },
                    aggregatedData: currentAggregatedData,
                },
                savedAt: Date.now()
            };

            try {
                const newId = await dbSaveReport(reportData);
                alert(`Report saved successfully! (ID: ${newId})`);
                closeAIModal();
            } catch (e) {
                console.error("Failed to save report:", e);
                alert("Error saving report: " + e.message);
            }
        }

        // ==========================================
        // üîç CATEGORY DRILL-DOWN LOGIC
        // ==========================================
        let activeCategoryColumn = '';
        let activeDescriptionColumn = '';
        let activeCategoryRows = [];
        let currentTicketPage = 0;
        const TICKETS_PER_PAGE = 10;

        // Helper to handle inconsistent column names (case/whitespace)
        function getValueFuzzy(row, colName) {
            if (!row || !colName) return undefined;
            if (row[colName] !== undefined) return row[colName];

            const lower = colName.trim().toLowerCase();
            const foundKey = Object.keys(row).find(k => k.trim().toLowerCase() === lower);
            return foundKey ? row[foundKey] : undefined;
        }

        function openCategoryAnalysis(catCol, descCol, title) {
            activeCategoryColumn = catCol;
            activeDescriptionColumn = descCol;

            const modal = document.getElementById('categoryDetailsModal');
            modal.classList.remove('hidden');
            document.getElementById('catModalTitle').innerText = title;

            // Aggregate Data
            const counts = {};
            let total = 0;
            filteredData.forEach(r => {
                const c = getValueFuzzy(r, catCol);
                if (c && c.toLowerCase() !== 'na' && c.trim() !== '') {
                    counts[c] = (counts[c] || 0) + 1;
                    total++;
                }
            });

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            const list = document.getElementById('catModalList');
            list.innerHTML = '';

            if (sorted.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-xs p-2">No data available.</p>';
            }

            sorted.forEach(([cat, count]) => {
                const pct = ((count / total) * 100).toFixed(1);
                const div = document.createElement('div');
                div.className = "p-3 border-b border-slate-700/50 hover:bg-slate-700 cursor-pointer transition-colors flex justify-between items-center group";
                div.onclick = () => showCategoryTickets(cat);
                div.innerHTML = `
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-bold text-gray-200 truncate pr-2" title="${cat}">${cat}</span>
                            <span class="text-accent-blue font-mono">${pct}%</span>
                        </div>
                        <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                            <div class="bg-accent-blue h-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                    <div class="ml-3 text-[10px] text-gray-500 font-mono bg-slate-800 px-1.5 py-0.5 rounded">${count}</div>
                `;
                list.appendChild(div);
            });

            // Reset Right Pane
            document.getElementById('catModalContent').innerHTML = '<div class="h-full flex items-center justify-center text-gray-500 text-sm opacity-50"><div class="text-center"><i class="fa-solid fa-list-ul text-3xl mb-2"></i><p>Select a category to view details</p></div></div>';
            document.getElementById('catModalLoadMoreBtn').classList.add('hidden');
            document.getElementById('catModalSubtitle').innerText = 'Details';
        }

        function showCategoryTickets(category) {
            // Filter rows
            activeCategoryRows = filteredData.filter(r => getValueFuzzy(r, activeCategoryColumn) === category);
            currentTicketPage = 0;

            document.getElementById('catModalSubtitle').innerText = category;

            // Add Summary Button to Header
            const countSpan = document.getElementById('catModalCount');
            countSpan.innerHTML = `
                <span class="mr-3 text-gray-400">${activeCategoryRows.length} tickets</span>
                <button onclick="summarizeCurrentCategory('${category.replace(/'/g, "\\'")}')" 
                    class="bg-gradient-to-r from-accent-purple to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-3 py-1 rounded text-[10px] font-bold transition-all shadow-lg border border-white/10">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI Summary
                </button>
            `;

            // Setup Content Area with Summary Container + List Container
            document.getElementById('catModalContent').innerHTML = `
                <div id="catSummaryContainer" class="hidden mb-4 p-4 bg-slate-800/80 rounded-lg border border-accent-purple/30 relative">
                    <h5 class="text-xs font-bold text-accent-purple mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> AI Category Summary
                    </h5>
                    <div id="catSummaryText" class="text-xs text-gray-300 leading-relaxed whitespace-pre-wrap"></div>
                </div>
                <div id="catTicketsList" class="space-y-3"></div>
            `;

            document.getElementById('catModalLoadMoreBtn').classList.remove('hidden');

            renderMoreTickets();
        }

        function renderMoreTickets() {
            const start = currentTicketPage * TICKETS_PER_PAGE;
            const end = start + TICKETS_PER_PAGE;
            const slice = activeCategoryRows.slice(start, end);

            const container = document.getElementById('catTicketsList');

            if (slice.length === 0 && currentTicketPage === 0) {
                container.innerHTML = '<div class="p-4 text-gray-500 italic text-sm">No details available for this category.</div>';
                document.getElementById('catModalLoadMoreBtn').classList.add('hidden');
                return;
            }

            slice.forEach(row => {
                const desc = getValueFuzzy(row, activeDescriptionColumn) || 'No description available';
                const id = row['ticket_id'] || row['Ticket ID'] || '#';

                // Check for transcript
                const transcript = row['transcript'] || row['Transcript'];
                const hasTranscript = transcript && transcript.trim().length > 0;
                const safeId = String(id).replace(/'/g, "\\'");

                const div = document.createElement('div');
                div.className = "bg-slate-800/50 p-3 rounded border border-slate-700 text-sm text-gray-300 mb-2 hover:bg-slate-800 transition-colors";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] text-accent-blue font-mono bg-slate-900 px-1.5 py-0.5 rounded">ID: ${id}</span>
                        ${hasTranscript ?
                        `<button onclick="viewTranscript('${safeId}')" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded border border-slate-600 transition-colors flex items-center gap-1">
                                <i class="fa-regular fa-file-lines"></i> Transcript
                             </button>`
                        : '<span class="text-[10px] text-gray-600 italic">No Transcript</span>'}
                    </div>
                    <p class="leading-relaxed text-gray-400">${desc}</p>
                `;
                container.appendChild(div);
            });

            currentTicketPage++;

            if (end >= activeCategoryRows.length) {
                document.getElementById('catModalLoadMoreBtn').classList.add('hidden');
            }
        }

        function viewTranscript(ticketId) {
            const ticket = filteredData.find(r => String(r['ticket_id'] || r['Ticket ID']) === String(ticketId));
            if (!ticket) return alert("Ticket not found.");

            const transcript = ticket['transcript'] || ticket['Transcript'] || "No transcript content.";

            document.getElementById('transcriptContent').innerText = transcript;
            document.getElementById('transcriptModal').classList.remove('hidden');
        }

        async function summarizeCurrentCategory(category) {
            const container = document.getElementById('catSummaryContainer');
            const textArea = document.getElementById('catSummaryText');

            container.classList.remove('hidden');
            textArea.innerHTML = '<div class="flex items-center gap-2 text-gray-400"><i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing tickets...</div>';

            const apiKey = localStorage.getItem('cx_gemini_key');
            if (!apiKey) {
                textArea.innerHTML = '<span class="text-accent-red">API Key missing. Please set it in AI Analyst or Settings.</span>';
                return;
            }

            // Gather descriptions (limit to top 50 to avoid token limits)
            const descriptions = activeCategoryRows
                .slice(0, 50)
                .map(r => getValueFuzzy(r, activeDescriptionColumn))
                .filter(d => d && d.trim().length > 0)
                .map(d => `- ${d}`)
                .join('\n');

            if (!descriptions) {
                textArea.innerText = "No sufficient data to summarize.";
                return;
            }

            const prompt = `
                You are a CX Analyst. Summarize the following customer issues related to the category "${category}".
                Identify the core recurring problems and provide a brief, actionable summary (max 3-4 sentences).
                
                Issues:
                ${descriptions}
            `;

            try {
                const model = "gemini-2.5-flash";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Simple formatting
                    textArea.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>');

                    // Add Save Button
                    const btnHtml = `
                        <div class="mt-3 flex justify-end border-t border-white/10 pt-2">
                            <button onclick="saveCategorySummaryToArchive('${category.replace(/'/g, "\\'")}')" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs font-bold transition-colors border border-slate-600 shadow-sm flex items-center gap-2">
                                <i class="fa-solid fa-archive"></i> Save to Archive
                            </button>
                        </div>`;
                    textArea.insertAdjacentHTML('beforeend', btnHtml);
                } else {
                    throw new Error("No response text");
                }
            } catch (e) {
                console.error(e);
                textArea.innerHTML = `<span class="text-accent-red">Analysis failed: ${e.message}</span>`;
            }
        }

        async function saveCategorySummaryToArchive(category) {
            const textArea = document.getElementById('catSummaryText');
            // Get text content without the button
            const clone = textArea.cloneNode(true);
            const btnDiv = clone.querySelector('div');
            if (btnDiv) btnDiv.remove();
            const summaryHtml = clone.innerHTML;

            const region = document.getElementById('countryFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            const reportData = {
                htmlContent: `<h3 class="text-xl font-bold text-accent-purple mb-2">Category Analysis: ${category}</h3><div class="prose prose-invert max-w-none text-sm text-gray-300">${summaryHtml}</div>`,
                context: {
                    region: region,
                    dateRange: { start, end },
                    type: 'Category Summary',
                    category: category
                },
                savedAt: Date.now()
            };

            try {
                await dbSaveReport(reportData);
                alert("Summary saved to Reports Archive!");
            } catch (e) {
                console.error(e);
                alert("Failed to save: " + e.message);
            }
        }

        function loadSavedTopIssues() {
            // Deprecated: Old Top 10 logic removed in favor of dynamic modal
        }

        function closeCategoryModal() {
            document.getElementById('categoryDetailsModal').classList.add('hidden');
        }

        function openIssueAnalysisModal(column, issue) {
            const modal = document.getElementById('issueAnalysisModal');
            if (!modal) {
                alert('Issue Analysis modal is not ready.');
                return;
            }
            // You would pass the column and issue to a function within the modal's scope
            // For now, we just open it.
            modal.classList.remove('hidden');

            // Example of how you might populate it (if the modal's script is loaded)
            if (window.loadIssueData) {
                window.loadIssueData(column, issue);
            }
        }

        function closeIssueAnalysisModal() {
            const modal = document.getElementById('issueAnalysisModal');
            if (modal) modal.classList.add('hidden');
        }

        // ==========================================
        // ‚å®Ô∏è KEYBOARD SHORTCUTS
        // ==========================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const stack = [
                    { id: 'transcriptModal' }, // z-110
                    { id: 'categoryDetailsModal', fn: closeCategoryModal }, // z-100
                    { id: 'ticketIntelligenceModal', fn: closeTicketIntelligenceModal }, // z-80
                    { id: 'reportsArchiveModal', fn: closeReportsArchive }, // z-80
                    { id: 'recommendationsModal', fn: () => document.getElementById('recommendationsModal').classList.add('hidden') }, // z-100
                    { id: 'aiModal', fn: closeAIModal }, // z-70
                    { id: 'issueAnalysisModal', fn: closeIssueAnalysisModal }, // z-70
                    { id: 'settingsModal', fn: closeSettings } // z-60
                ];

                for (const item of stack) {
                    const el = document.getElementById(item.id);
                    if (el && !el.classList.contains('hidden')) {
                        if (item.fn) item.fn();
                        else el.classList.add('hidden');
                        e.preventDefault();
                        return; // Close only one at a time
                    }
                }
            }
        });
    </script>
</body>

</html>